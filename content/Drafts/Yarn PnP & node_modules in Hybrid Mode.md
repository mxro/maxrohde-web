


All version of Yarn from v2 support a new way to manage dependency locally: [the plug'n'play linker](https://yarnpkg.com/features/pnp).

This way of managing dependencies is much faster and safer than the traditional way of storing dependencies in `node_modules` folder.

However, a number of popular frameworks are not compatible with this way of dependency management, notably [React Native](https://github.com/react-native-community/cli/issues/27).

Yarn 3+ provides a neat way to handle these frameworks within a larger monorepo, a [Hybrid PnP + node_modules](https://yarnpkg.com/getting-started/recipes) configuration.

I have put together a minimal configuration to demonstrate how this can be set up:

GitHub [mxro/yarn-pnp-react-native](https://github.com/mxro/yarn-pnp-react-native)

The key files where the configuration needs to be provided are:

## [`.yarnrc.yml`](https://github.com/mxro/yarn-pnp-react-native/blob/master/.yarnrc.yml)

```
nmHoistingLimits: none

nodeLinker: pnp

pnpIgnorePatterns:
  - ./packages/app/**

pnpMode: loose

yarnPath: .yarn/releases/yarn-4.0.2.cjs
```

Note here we are setting:

- `nmHoistingLimits: none` in order to allow the sub-workspace that is set to use the `node_modules` linker to access other workspaces in the repo
- `nodeLinker: pnp` to ensure we are using the `pnp` linker in the main workspace.
- `pnpIgnorePatterns` to ensure the workspaces handled with the `node_modules` linker is not included in our pnp linking

## [packages/app/package.json](https://github.com/mxro/yarn-pnp-react-native/blob/master/packages/app/package.json#L7)

```yml
{
  "name": "app",
  "version": "1.0.0",
  "main": "index.js",
  "license": "MIT",
  "installConfig": {
    "hoistingLimits": "workspaces"
  },
  "dependencies": {
    "@local/lib": "workspace:^"
  }
}
```

Here we are setting:

- `installConfig` / `hoistingLimits`: to ensure we can use other packages in the repo
- `dependencies`: an example local dependency

## [packages/app/.yarnrc.yml](https://github.com/mxro/yarn-pnp-react-native/blob/master/packages/app/.yarnrc.yml#L1)

```yml
nodeLinker: node-modules
```

Here we set the `nodeLinker` to `node-modules` which will result in creating a `node_modules` folder for this workspace.


## Related Discussions

- [Hybrid node_modules & pnp - How do local dependencies work?](https://github.com/yarnpkg/berry/discussions/6050)
- [[Bug?]: Mixing pnp / node-modules and hoisting doesn't work](https://github.com/yarnpkg/berry/issues/5101)
- [[Bug?]: Installing a hybrid mono-repo with node-modules nmLinker package inside a pnp nmLinker root causes package to install itself in circular dependency loop](https://github.com/yarnpkg/berry/issues/4232)
- [Using pnp and node_modules together](https://github.com/yarnpkg/berry/discussions/4363)
- [How to use Yarn Berry with React Native](https://levelup.gitconnected.com/how-to-use-yarn-3-with-react-native-and-how-to-migrate-c5f108108533)
- [Setting up React Native Monorepo With Yarn Workspaces](https://www.callstack.com/blog/setting-up-react-native-monorepo-with-yarn-workspaces)
